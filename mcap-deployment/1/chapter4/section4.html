<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Install and Configure Operators :: Deploy Mission Critical Application Platform (MCAP)</title>
    <link rel="prev" href="section3.html">
    <link rel="next" href="section5.html">
    <meta name="generator" content="Antora 3.1.3">
    <link rel="stylesheet" href="../../../_/css/site.css">
    <script>var uiRootPath = '../../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://www.redhat.com" target="_blank"><img src="../../../_/img/redhat-logo.png" height="40px" alt="Red Hat"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="../../..">Deploy Mission Critical Application Platform (MCAP)</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://github.com/RedHatQuickCourses/mcap-deployment/issues" target="_blank">Report Issues</a>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="mcap-deployment" data-version="1">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">Deploy Mission Critical Application Platform (MCAP)</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../index.html">Home</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../chapter1/index.html">Hands-on Lab Environment Setup for MCAP</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../chapter1/section1.html">MCAP Setup in RHDP Lab</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../chapter1/section2.html">Initial Setup on Hypervisor</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../chapter1/section3.html">Storage VM Deployment</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../chapter1/section4.html">Ceph Storage Deployment</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../chapter2/index.html">Hub Cluster Deployment</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../chapter2/section1.html">Hub VM Deployment</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../chapter2/section2.html">Assisted Clusters - Hub Cluster</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../chapter2/section3.html">Access the Hub Cluster</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../chapter2/section4.html">Install Operators and Configure Service</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../chapter3/index.html">Infrastructure Cluster Deployment</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../chapter3/section1.html">Infrastructure VMs Deployment</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../chapter3/section2.html">Assisted Clusters - Infrastructure Clusters</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../chapter3/section3.html">Access the Infrastructure Cluster</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../chapter3/section4.html">Install and Configure Operators</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../chapter3/section5.html">Network Settings</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="index.html">Tenant Cluster Deployment</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="section1.html">Tenant VMs Deployment</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="section2.html">Assisted Clusters - Tenant Cluster</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="section3.html">Access the Tenant Cluster</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="section4.html">Install and Configure Operators</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="section5.html">Install Sample Application on Tenant Cluster</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../appendix/appendix.html">Appendix A</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../appendix/section1.html">Initial Setup on Hypervisor without Automation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../appendix/section2.html">Storage VM Deployment without Automation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../appendix/section3.html">Hub VM Deployment without Automation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../appendix/section4.html">Infrastructure VM Deployment without Automation</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Deploy Mission Critical Application Platform (MCAP)</span>
    <span class="version">1</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../index.html">Deploy Mission Critical Application Platform (MCAP)</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">1</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Deploy Mission Critical Application Platform (MCAP)</a></li>
    <li><a href="index.html">Tenant Cluster Deployment</a></li>
    <li><a href="section4.html">Install and Configure Operators</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Install and Configure Operators</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>In this section, you will be installing the OpenShift Data Foundation operator on the <em>Tenant</em> cluster.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/MCAP_setup_1.png" alt="MCAP setup 1">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_prerequisites"><a class="anchor" href="#_prerequisites"></a>Prerequisites</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Verify that the <em>tenant</em> cluster is deployed successfully.</p>
</li>
<li>
<p>Access the <em>tenant</em> cluster via CLI and the web console.</p>
</li>
<li>
<p>Ensure that all nodes are in <code>Ready</code> status and that all cluster operators are available.</p>
<div class="listingblock">
<div class="title">Sample output:</div>
<div class="content">
<pre>[root@hypervisor ~]# oc get nodes
NAME                   STATUS     ROLES                         AGE   VERSION
tcn1.lab.example.com   Ready      control-plane,master,worker   15h   v1.29.7+4510e9c
tcn2.lab.example.com   NotReady   control-plane,master,worker   14h   v1.29.7+4510e9c
tcn3.lab.example.com   Ready      control-plane,master,worker   15h   v1.29.7+4510e9c

[root@hypervisor ~]# oc get clusterversion

NAME      VERSION   AVAILABLE   PROGRESSING   SINCE   STATUS
version   4.16.8    True        False         23h     Cluster version is 4.16.8</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_install_openshift_data_foundation_operator"><a class="anchor" href="#_install_openshift_data_foundation_operator"></a>Install OpenShift Data Foundation Operator</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Access the operator hub from the web console of the <em>tenant</em> cluster.</p>
<div class="paragraph">
<p>From the left navigation pane, click <span class="menuseq"><b class="menu">Operators</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">OperatorHub</b></span>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/tenant_console_operator_hub.png" alt="tenant console operator hub">
</div>
</div>
</li>
<li>
<p>In a search window, search <em>odf</em> and select the <code>OpenShift Data Foundation</code>.</p>
<div class="imageblock">
<div class="content">
<img src="_images/tenant_console_odf_install.png" alt="tenant console odf install">
</div>
</div>
</li>
<li>
<p>Click <b class="button">Install</b> to open the install options.</p>
<div class="imageblock">
<div class="content">
<img src="_images/tenant_console_odf_install_1.png" alt="tenant console odf install 1">
</div>
</div>
</li>
<li>
<p>Keep all options as is (with no change) in selected options and then click <b class="button">Install</b> to install the operator.</p>
<div class="imageblock">
<div class="content">
<img src="_images/tenant_console_odf_install_2.png" alt="tenant console odf install 2">
</div>
</div>
</li>
<li>
<p>After 3-4 minutes, you should notice a message telling you to the <code>Refresh web console</code> message on the window.</p>
<div class="paragraph">
<p>First, refresh the web console and then click <b class="button">Create StorageSystem</b> to create the resource.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/tenant_console_odf_install_3.png" alt="tenant console odf install 3">
</div>
</div>
</li>
<li>
<p>Create the StorageSystem.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Provide backing storage details.</p>
<div class="paragraph">
<p>Deployment type: <code>Full deployment</code>.</p>
</div>
<div class="paragraph">
<p>Select <code>Connect an external storage platform</code>.</p>
</div>
<div class="paragraph">
<p>Storage platform: <code>Red Hat Ceph Storage</code>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/tenant_console_odf_install_4.png" alt="tenant console odf install 4">
</div>
</div>
<div class="paragraph">
<p>Check the <code>Use Ceph RBD as the default StorageClass</code> box.</p>
</div>
<div class="paragraph">
<p>Click <b class="button">Next</b> to proceed.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/tenant_console_odf_install_5.png" alt="tenant console odf install 5">
</div>
</div>
</li>
<li>
<p>Click <b class="button">Browse</b> to provide the content of the <code>output.json</code> file.</p>
<div class="imageblock">
<div class="content">
<img src="_images/tenant_console_odf_install_7.png" alt="tenant console odf install 7">
</div>
</div>
</li>
<li>
<p>Select the <code>output.json</code> file and click <b class="button">Open</b>.</p>
<div class="imageblock">
<div class="content">
<img src="_images/tenant_console_odf_install_8.png" alt="tenant console odf install 8">
</div>
</div>
</li>
<li>
<p>Click <b class="button">Next</b> to proceed.</p>
<div class="imageblock">
<div class="content">
<img src="_images/tenant_console_odf_install_9.png" alt="tenant console odf install 9">
</div>
</div>
</li>
<li>
<p>Click <b class="button">Create StorageSystem</b> to create the StorageSystem.</p>
<div class="imageblock">
<div class="content">
<img src="_images/tenant_console_odf_install_10.png" alt="tenant console odf install 10">
</div>
</div>
</li>
<li>
<p>Note the raw and used capacity.</p>
<div class="imageblock">
<div class="content">
<img src="_images/tenant_console_odf_install_11.png" alt="tenant console odf install 11">
</div>
</div>
</li>
<li>
<p>Note the conditions as <code>Available, VendorCsv Ready, and Vendor System Present</code>.</p>
<div class="imageblock">
<div class="content">
<img src="_images/tenant_console_odf_install_12.png" alt="tenant console odf install 12">
</div>
</div>
</li>
<li>
<p>Verify that the operator is installed successfully in <code>openshift-storage</code> namespace.</p>
<div class="imageblock">
<div class="content">
<img src="_images/tenant_console_odf_install_13.png" alt="tenant console odf install 13">
</div>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configure_the_image_registry_operator_to_use_noobaa_storage_with_red_hat_openshift_data_foundation"><a class="anchor" href="#_configure_the_image_registry_operator_to_use_noobaa_storage_with_red_hat_openshift_data_foundation"></a>Configure the Image Registry Operator to use Noobaa storage with Red Hat OpenShift Data Foundation</h2>
<div class="sectionbody">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<a href="https://docs.redhat.com/en/documentation/openshift_container_platform/4.11/html/registry/setting-up-and-configuring-the-registry#registry-configuring-registry-storage-rhodf-nooba_configuring-registry-storage-baremetal" target="read-later">Configuring the Image Registry Operator to use Noobaa storage with Red Hat OpenShift Data Foundation</a>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create the object bucket claim using the <code>openshift-storage.noobaa.io</code> storage class.</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cat &lt;&lt;EOF | oc apply -f -
apiVersion: objectbucket.io/v1alpha1
kind: ObjectBucketClaim
metadata:
  name: noobaatest
  namespace: openshift-storage
spec:
  storageClassName: openshift-storage.noobaa.io
  generateBucketName: noobaatest
EOF</code></pre>
</div>
</div>
</li>
<li>
<p>Get the bucket name by entering the following command:</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">bucket_name=$(oc get obc -n openshift-storage noobaatest -o jsonpath='{.spec.bucketName}')</code></pre>
</div>
</div>
</li>
<li>
<p>Get the AWS credentials by entering the following commands:</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">AWS_ACCESS_KEY_ID=$(oc get secret -n openshift-storage noobaatest -o yaml | grep -w "AWS_ACCESS_KEY_ID:" | head -n1 | awk '{print $2}' | base64 --decode)</code></pre>
</div>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">AWS_SECRET_ACCESS_KEY=$(oc get secret -n openshift-storage noobaatest -o yaml | grep -w "AWS_SECRET_ACCESS_KEY:" | head -n1 | awk '{print $2}' | base64 --decode)</code></pre>
</div>
</div>
</li>
<li>
<p>Create the secret <code>image-registry-private-configuration-user</code> with the AWS credentials for the new bucket under <code>openshift-image-registry</code> project by entering the following command:</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc create secret generic image-registry-private-configuration-user --from-literal=REGISTRY_STORAGE_S3_ACCESSKEY=${AWS_ACCESS_KEY_ID} --from-literal=REGISTRY_STORAGE_S3_SECRETKEY=${AWS_SECRET_ACCESS_KEY} --namespace openshift-image-registry</code></pre>
</div>
</div>
</li>
<li>
<p>Get the route host by entering the following command:</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">route_host=$(oc get route s3 -n openshift-storage -o=jsonpath='{.spec.host}')</code></pre>
</div>
</div>
</li>
<li>
<p>Create a config map that uses an ingress certificate by entering the following commands:</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc extract secret/router-certs-default -n openshift-ingress --confirm</code></pre>
</div>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc create configmap image-registry-s3-bundle --from-file=ca-bundle.crt=./tls.crt  -n openshift-config</code></pre>
</div>
</div>
</li>
<li>
<p>Configure the image registry to use the <code>Nooba</code> object storage by entering the following command:</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc patch config.image/cluster -p '{"spec":{"managementState":"Managed","replicas":2,"storage":{"managementState":"Unmanaged","s3":{"bucket":'\"${bucket_name}\"',"region":"us-east-1","regionEndpoint":'\"https://${route_host}\"',"virtualHostedStyle":false,"encrypt":false,"trustedCA":{"name":"image-registry-s3-bundle"}}}}}' --type=merge</code></pre>
</div>
</div>
</li>
<li>
<p>Note that <code>image-registry</code> cluster operator is in progressing state.</p>
<div class="listingblock">
<div class="title">Sample output:</div>
<div class="content">
<pre>[root@hypervisor ~]# oc get co image-registry
NAME             VERSION   AVAILABLE   PROGRESSING   DEGRADED   SINCE   MESSAGE
image-registry   4.16.8    False       True          False      13s     Available: The deployment does not have available replicas...</pre>
</div>
</div>
</li>
<li>
<p>In a minute, <code>image-registry</code> cluster operator will be available.</p>
<div class="listingblock">
<div class="title">Sample output:</div>
<div class="content">
<pre>[root@hypervisor ~]# oc get co image-registry
NAME             VERSION   AVAILABLE   PROGRESSING   DEGRADED   SINCE   MESSAGE
image-registry   4.16.8    True        False         False      61s</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="section3.html">Access the Tenant Cluster</a></span>
  <span class="next"><a href="section5.html">Install Sample Application on Tenant Cluster</a></span>
</nav>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <img src="../../../_/img/rhl-logo-red.png" height="40px" alt="Red Hat"  href="https://redhat.com" >
</footer><script id="site-script" src="../../../_/js/site.js" data-ui-root-path="../../../_"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
