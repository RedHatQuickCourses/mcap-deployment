<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Ceph Storage Deployment :: Deploy Mission Critical Application Platform (MCAP)</title>
    <link rel="prev" href="section3.html">
    <link rel="next" href="../chapter2/index.html">
    <meta name="generator" content="Antora 3.1.3">
    <link rel="stylesheet" href="../../../_/css/site.css">
    <script>var uiRootPath = '../../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://www.redhat.com" target="_blank"><img src="../../../_/img/redhat-logo.png" height="40px" alt="Red Hat"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="../../..">Deploy Mission Critical Application Platform (MCAP)</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://github.com/RedHatQuickCourses/mcap-deployment/issues" target="_blank">Report Issues</a>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="mcap-deployment" data-version="1">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">Deploy Mission Critical Application Platform (MCAP)</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../index.html">Home</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="index.html">Hands-on Lab Environment Setup for MCAP</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="section1.html">MCAP Setup in RHDP Lab</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="section2.html">Initial Setup on Hypervisor</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="section3.html">Storage VM Deployment</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="section4.html">Ceph Storage Deployment</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../chapter2/index.html">Hub Cluster Deployment</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../chapter2/section1.html">Hub VM Deployment</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../chapter2/section2.html">Assisted Clusters - Hub Cluster</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../chapter2/section3.html">Access the Hub Cluster</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../chapter2/section4.html">Install Operators and Configure Service</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../chapter3/index.html">Infrastructure Cluster Deployment</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../chapter3/section1.html">Infrastructure VMs Deployment</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../chapter3/section2.html">Assisted Clusters - Infrastructure Clusters</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../chapter3/section3.html">Access the Infrastructure Cluster</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../chapter3/section4.html">Install and Configure Operators</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../chapter3/section5.html">Network Settings</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../chapter4/index.html">Tenant Cluster Deployment</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../chapter4/section1.html">Tenant VM Configuration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../chapter4/section2.html">Install Sample Application on Tenant Cluster</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../appendix/appendix.html">Appendix A</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../appendix/section1.html">Initial Setup on Hypervisor without Automation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../appendix/section2.html">Storage VM Deployment without Automation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../appendix/section3.html">Hub VM Deployment without Automation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../appendix/section4.html">Infrastructure VM Deployment without Automation</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Deploy Mission Critical Application Platform (MCAP)</span>
    <span class="version">1</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../index.html">Deploy Mission Critical Application Platform (MCAP)</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">1</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Deploy Mission Critical Application Platform (MCAP)</a></li>
    <li><a href="index.html">Hands-on Lab Environment Setup for MCAP</a></li>
    <li><a href="section4.html">Ceph Storage Deployment</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Ceph Storage Deployment</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>In this section, you will be deploying Ceph on <code>storage</code> VM.
This <code>storage</code> VM will be single node and three disks Ceph cluster.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/MCAP_setup_3.png" alt="MCAP setup 3">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_prerequisites"><a class="anchor" href="#_prerequisites"></a>Prerequisites</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>storage</code> VM is deployed and running.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ceph_storage_deployment_prerequisites"><a class="anchor" href="#_ceph_storage_deployment_prerequisites"></a>Ceph Storage Deployment Prerequisites</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Take the console of the <code>storage</code> VM and login as <em>root</em> user with <em>redhat</em> as password.</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">virsh console storage</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Sample output:</div>
<div class="content">
<pre>[root@hypervisor images]# virsh console storage
Connected to domain 'storage'
Escape character is ^] (Ctrl + ])

storage login: root
Password:
[root@storage ~]#</pre>
</div>
</div>
</li>
<li>
<p>Register the <code>storage</code> VM with valid subscription.
You will need to provide your customer portal (access.redhat.com) credentials.</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">subscription-manager register</code></pre>
</div>
</div>
<div class="paragraph">
<p>Disable the all repos.</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">subscription-manager repos --disable=*</code></pre>
</div>
</div>
<div class="paragraph">
<p>Enable only required and Ceph repos.</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">subscription-manager repos --enable=rhel-9-for-x86_64-baseos-rpms --enable=rhel-9-for-x86_64-appstream-rpms --enable=rhceph-7-tools-for-rhel-9-x86_64-rpms</code></pre>
</div>
</div>
<div class="paragraph">
<p>Check the repo list and ensure all required repos are enabled.</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">dnf repolist</code></pre>
</div>
</div>
</li>
<li>
<p>Update all packages on the <code>storage</code> VM to latest version.</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">dnf -y update</code></pre>
</div>
</div>
</li>
<li>
<p>Install Ceph packages on the <code>storage</code> VM.</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">dnf -y install cephadm ceph-common lvm2 chrony podman</code></pre>
</div>
</div>
</li>
<li>
<p>Reboot the <code>storage</code> VM.</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">reboot</code></pre>
</div>
</div>
</li>
<li>
<p>Permit <code>root</code> login on <code>storage</code> VM.
This will allow the login to <code>storage</code> VM as <code>root</code> user using <code>ssh</code> connection.</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">echo "PermitRootLogin yes" &gt;&gt; /etc/ssh/sshd_config</code></pre>
</div>
</div>
<div class="paragraph">
<p>Restart the <code>sshd</code> service for configuration changes.</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">systemctl restart sshd</code></pre>
</div>
</div>
</li>
<li>
<p>Generate key using <code>ssh-keygen</code>, copy id to <code>storage</code> VM itself for password-less login.
This sets up SSH public key authentication to connect to a remote system.</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">ssh-keygen -t rsa -f /root/.ssh/id_rsa -N ''</code></pre>
</div>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">ssh-copy-id storage.lab.example.com</code></pre>
</div>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">eval $(ssh-agent)</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>ssh-agent</code> is a background program that handles passwords for SSH private keys.</p>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">ssh-add ~/.ssh/id_rsa</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>ssh-add</code> command prompts the user for a private key password and adds it to the list maintained by <code>ssh-agent</code>.
Once you add a password to <code>ssh-agent</code>, you will not be prompted for it when using SSH or scp to connect to hosts with your public key.</p>
</div>
</li>
<li>
<p>Create the <code>/etc/auth.json</code> file.
This file will be used in Ceph cluster deployment for getting access to container image catalog.</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cat &gt;/etc/auth.json&lt;&lt;EOF
{
 "url":"registry.redhat.io",
 "username":"yourusername",
 "password":"yourpassword"
}
EOF</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Replace "yourusername" with your username and "yourpassword" with your password for registry.redhat.io.
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ceph_configuration_and_deployment"><a class="anchor" href="#_ceph_configuration_and_deployment"></a>Ceph Configuration and Deployment</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create the Ceph spec file <code>initial-config.yaml</code>, which is used as initial configuration for Ceph cluster deployment.
There is only a single Ceph cluster node i.e. <code>storage</code> VM, used to deploy Ceph cluster.
You need to provide <code>storage</code> VM details in the spec file such as IP address, hostname, host and three disks attached to <code>storage</code> VM.</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cat &gt;initial-config.yaml&lt;&lt;EOF
---
service_type: host
addr: 192.168.122.9
hostname: storage.lab.example.com
---
service_type: mon
placement:
  hosts:
    - storage.lab.example.com
---
service_type: rgw
service_id: realm.zone
placement:
  hosts:
    - storage.lab.example.com
---
service_type: mgr
placement:
  hosts:
    - storage.lab.example.com
---
service_type: osd
service_id: default_drive_group
placement:
  host_pattern: 'storage*'
data_devices:
  paths:
    - /dev/vdb
    - /dev/vdc
    - /dev/vdd
EOF</code></pre>
</div>
</div>
</li>
<li>
<p>Deploy the Ceph storage cluster with following command.
You will need to pass the spec file as <code>initial-config.yaml</code>, mon IP as <code>storage</code> VM&#8217;s IP and registry json file as <code>/etc/auth.json</code>.
To deploy a Ceph cluster running on a single host, use the <code>--single-host-defaults</code> flag when bootstrapping.</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cephadm bootstrap --apply-spec initial-config.yaml --mon-ip 192.168.122.9 --registry-json /etc/auth.json --allow-fqdn-hostname --single-host-defaults</code></pre>
</div>
</div>
</li>
<li>
<p>Verify deployed Ceph cluster.</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">/usr/sbin/cephadm shell</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Sample output:</div>
<div class="content">
<pre>Inferring fsid 47cd0eae-5e5c-11ef-a284-5254000aa988
Inferring config /var/lib/ceph/47cd0eae-5e5c-11ef-a284-5254000aa988/mon.storage/config
Using ceph image with id '3fd804e38f5b' and tag 'latest' created on 2024-07-31 19:44:24 +0000 UTC
registry.redhat.io/rhceph/rhceph-7-rhel9@sha256:75bd8969ab3f86f2203a1ceb187876f44e54c9ee3b917518c4d696cf6cd88ce3
[ceph: root@storage /]#</pre>
</div>
</div>
<div class="listingblock">
<div class="title">Sample output:</div>
<div class="content">
<pre>[ceph: root@storage /]# ceph -s
  cluster:
    id:     47cd0eae-5e5c-11ef-a284-5254000aa988
    health: HEALTH_OK

  services:
    mon: 1 daemons, quorum storage (age 18m)
    mgr: storage.wudgfp(active, since 16m)
    osd: 3 osds: 3 up (since 16m), 3 in (since 17m)
    rgw: 1 daemon active (1 hosts, 1 zones)

  data:
    pools:   5 pools, 129 pgs
    objects: 191 objects, 453 KiB
    usage:   148 MiB used, 5.9 TiB / 5.9 TiB avail
    pgs:     129 active+clean</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You may have to wait for approximately 5 to 10 minutes for all the background processes needed for installation to complete and the cluster to be in <code>HEALTH_OK</code> state.
You may track the progress with watch <code>ceph -s</code> command.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>You may also run <code>ceph health</code> command to verify cluster status.</p>
<div class="listingblock">
<div class="title">Sample output:</div>
<div class="content">
<pre>[ceph: root@storage /]# ceph health
HEALTH_OK</pre>
</div>
</div>
</li>
<li>
<p>In case of failure, you can use following command to destroy the Ceph storage cluster.</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cephadm rm-cluster --force --zap-osds --fsid `ceph fsid`</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="section3.html">Storage VM Deployment</a></span>
  <span class="next"><a href="../chapter2/index.html">Hub Cluster Deployment</a></span>
</nav>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <img src="../../../_/img/rhl-logo-red.png" height="40px" alt="Red Hat"  href="https://redhat.com" >
</footer><script id="site-script" src="../../../_/js/site.js" data-ui-root-path="../../../_"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
