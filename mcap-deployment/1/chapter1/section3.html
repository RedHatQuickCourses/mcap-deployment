<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Ceph Storage Deployment :: Deploy Mission Critical Application Platform (MCAP)</title>
    <link rel="prev" href="section2.html">
    <link rel="next" href="../chapter2/index.html">
    <meta name="generator" content="Antora 3.1.3">
    <link rel="stylesheet" href="../../../_/css/site.css">
    <script>var uiRootPath = '../../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://www.redhat.com" target="_blank"><img src="../../../_/img/redhat-logo.png" height="40px" alt="Red Hat"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="../../..">Deploy Mission Critical Application Platform (MCAP)</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://github.com/RedHatQuickCourses/mcap-deployment/issues" target="_blank">Report Issues</a>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="mcap-deployment" data-version="1">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">Deploy Mission Critical Application Platform (MCAP)</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../index.html">Home</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="index.html">Hands-on Lab Environment Setup for MCAP</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="section1.html">MCAP Setup in Demo Lab</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="section2.html">Initial Setup on Hypervisor (Bare Metal)</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="section3.html">Ceph Storage Deployment</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../chapter2/index.html">Hub Cluster Deployment</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../chapter2/section1.html">Hub VM Configuration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../chapter2/section2.html">Install and Configure Operators and Service(s)</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../chapter3/index.html">Infrastructure Cluster Deployment</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../chapter3/section1.html">Infrastructure VM Configuration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../chapter3/section2.html">Install and Configure Operators</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../chapter4/index.html">Tenant Cluster Deployment</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../chapter4/section1.html">Tenant VM Configuration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../chapter4/section2.html">Install Sample Application on Tenant Cluster</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Deploy Mission Critical Application Platform (MCAP)</span>
    <span class="version">1</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../index.html">Deploy Mission Critical Application Platform (MCAP)</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">1</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Deploy Mission Critical Application Platform (MCAP)</a></li>
    <li><a href="index.html">Hands-on Lab Environment Setup for MCAP</a></li>
    <li><a href="section3.html">Ceph Storage Deployment</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Ceph Storage Deployment</h1>
<div class="sect1">
<h2 id="_prerequisites"><a class="anchor" href="#_prerequisites"></a>Prerequisites</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Download the rhel9 qcow2 image from the customer portal to your laptop/desktop.</p>
</li>
<li>
<p>Secured copy (scp) the rhel9 qcow2 image from your laptop/desktop to hypervisor.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_storage_vm_deployment"><a class="anchor" href="#_storage_vm_deployment"></a>Storage VM Deployment</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Keep the rhel9 qcow2 image to /var/lib/libvirt/images directory</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cd /var/lib/libvirt/images/</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Sample output</div>
<div class="content">
<pre>ls -alh /var/lib/libvirt/images/rhel-9.4-x86_64-kvm.qcow2
-rw-r--r--. 1 root root 913M Aug 19 05:44 /var/lib/libvirt/images/rhel-9.4-x86_64-kvm.qcow2</pre>
</div>
</div>
</li>
<li>
<p>Check the virtual and disk size of qcow2 image</p>
<div class="listingblock">
<div class="title">Sample output</div>
<div class="content">
<pre>qemu-img info rhel-9.4-x86_64-kvm.qcow2

image: rhel-9.4-x86_64-kvm.qcow2
file format: qcow2
virtual size: 10 GiB (10737418240 bytes)
disk size: 913 MiB
cluster_size: 65536
...output omitted...</pre>
</div>
</div>
</li>
<li>
<p>Resize the image</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">qemu-img resize rhel-9.4-x86_64-kvm.qcow2 +30G</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Sample output</div>
<div class="content">
<pre>qemu-img info rhel-9.4-x86_64-kvm.qcow2

image: rhel-9.4-x86_64-kvm.qcow2
file format: qcow2
virtual size: 40 GiB (42949672960 bytes)
disk size: 913 MiB
...output omitted...</pre>
</div>
</div>
</li>
<li>
<p>Change the ownership of the image</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">chown -R qemu:qemu rhel-9.4-x86_64-kvm.qcow2</code></pre>
</div>
</div>
</li>
<li>
<p>Resize the partition 4</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">virt-customize -a rhel-9.4-x86_64-kvm.qcow2 --run-command 'growpart /dev/sda 4'</code></pre>
</div>
</div>
</li>
<li>
<p>Increase the filesystem on /</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">virt-customize -a rhel-9.4-x86_64-kvm.qcow2 --run-command 'xfs_growfs /'</code></pre>
</div>
</div>
</li>
<li>
<p>Set the root password</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">virt-customize -a rhel-9.4-x86_64-kvm.qcow2 --root-password password:redhat</code></pre>
</div>
</div>
</li>
<li>
<p>Disable cloud-init</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">virt-customize -a rhel-9.4-x86_64-kvm.qcow2 --run-command 'systemctl disable cloud-init'</code></pre>
</div>
</div>
</li>
<li>
<p>Inject the root user&#8217;s public rsa key</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">virt-customize -a rhel-9.4-x86_64-kvm.qcow2 --ssh-inject root:file:/root/.ssh/id_rsa.pub</code></pre>
</div>
</div>
</li>
<li>
<p>Selinux relabel</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">virt-customize -a rhel-9.4-x86_64-kvm.qcow2 --selinux-relabel</code></pre>
</div>
</div>
</li>
<li>
<p>Create the image for storage VM using the rhel9 qcow2 image</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">qemu-img create -f qcow2 -F qcow2 -b /var/lib/libvirt/images/rhel-9.4-x86_64-kvm.qcow2 /var/lib/libvirt/images/storage.qcow2</code></pre>
</div>
</div>
</li>
<li>
<p>Create the storage VM with three 2TB disks</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">virt-install --virt-type kvm --ram 16384 --vcpus 4 --cpu=host-passthrough --os-variant rhel9.3 \
--disk path=/var/lib/libvirt/images/storage.qcow2,device=disk,bus=virtio,format=qcow2 \
--disk path=/var/lib/libvirt/images/ceph-disk1.qcow2,device=disk,bus=virtio,format=qcow2,size=2000 \
--disk path=/var/lib/libvirt/images/ceph-disk2.qcow2,device=disk,bus=virtio,format=qcow2,size=2000 \
--disk path=/var/lib/libvirt/images/ceph-disk3.qcow2,device=disk,bus=virtio,format=qcow2,size=2000 \
--network bridge=virbr0,mac=52:54:00:0a:a9:88 --boot hd,network --noautoconsole \
--vnc --name storage --noreboot</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Sample output</div>
<div class="content">
<pre>virsh list --all

 Id   Name      State
--------------------------
 -    storage   shut off</pre>
</div>
</div>
</li>
<li>
<p>Start the storage VM</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">virsh start storage</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Sample output</div>
<div class="content">
<pre>virsh list --all
 Id   Name      State
-------------------------
 1    storage   running</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ceph_storage_deployment_prerequisites"><a class="anchor" href="#_ceph_storage_deployment_prerequisites"></a>Ceph Storage Deployment Prerequisites</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Take the console of the storage VM and login as <em>root</em> user with <em>redhat</em> as password</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">virsh console storage</code></pre>
</div>
</div>
</li>
<li>
<p>Register the storage VM with valid subscription</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">subscription-manager register</code></pre>
</div>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">subscription-manager repos --disable=*</code></pre>
</div>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">subscription-manager repos --enable=rhel-9-for-x86_64-baseos-rpms --enable=rhel-9-for-x86_64-appstream-rpms --enable=rhceph-7-tools-for-rhel-9-x86_64-rpms</code></pre>
</div>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">dnf repolist</code></pre>
</div>
</div>
</li>
<li>
<p>Update all packages</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">dnf -y update</code></pre>
</div>
</div>
</li>
<li>
<p>Install ceph packages</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">dnf -y install cephadm ceph-common lvm2 chrony podman</code></pre>
</div>
</div>
</li>
<li>
<p>Reboot the storage VM</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">reboot</code></pre>
</div>
</div>
</li>
<li>
<p>Permit root login on storage node</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">echo "PermitRootLogin yes" &gt;&gt; /etc/ssh/sshd_config</code></pre>
</div>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">systemctl restart sshd</code></pre>
</div>
</div>
</li>
<li>
<p>Generate key using ssh-keygen, copy id to storage node itself for password-less login</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">ssh-keygen</code></pre>
</div>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">ssh-copy-id storage.lab.example.com</code></pre>
</div>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">eval $(ssh-agent)</code></pre>
</div>
</div>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">ssh-add ~/.ssh/id_rsa</code></pre>
</div>
</div>
</li>
<li>
<p>Create the /etc/auth.json file with your</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cat &gt;/etc/auth.json&lt;&lt;EOF
{
 "url":"registry.redhat.io",
 "username":"yourusername",
 "password":"yourpassword"
}
EOF</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Replace "yourusername" with your username and "yourpassword" with your password for registry.redhat.io.
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ceph_configuration_and_deployment"><a class="anchor" href="#_ceph_configuration_and_deployment"></a>Ceph Configuration and Deployment</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create the ceph spec file</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cat &gt;initial-config.yaml&lt;&lt;EOF
---
service_type: host
addr: 192.168.122.9
hostname: storage.lab.example.com
---
service_type: mon
placement:
  hosts:
    - storage.lab.example.com
---
service_type: rgw
service_id: realm.zone
placement:
  hosts:
    - storage.lab.example.com
---
service_type: mgr
placement:
  hosts:
    - storage.lab.example.com
---
service_type: osd
service_id: default_drive_group
placement:
  host_pattern: 'storage*'
data_devices:
  paths:
    - /dev/vdb
    - /dev/vdc
    - /dev/vdd
EOF</code></pre>
</div>
</div>
</li>
<li>
<p>Deploy the ceph storage cluster</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cephadm bootstrap --apply-spec initial-config.yaml --mon-ip 192.168.122.9 --registry-json /etc/auth.json --allow-fqdn-hostname --single-host-defaults</code></pre>
</div>
</div>
</li>
<li>
<p>Verify deployed cluster</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">/usr/sbin/cephadm shell</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Sample output</div>
<div class="content">
<pre>Inferring fsid 47cd0eae-5e5c-11ef-a284-5254000aa988
Inferring config /var/lib/ceph/47cd0eae-5e5c-11ef-a284-5254000aa988/mon.storage/config
Using ceph image with id '3fd804e38f5b' and tag 'latest' created on 2024-07-31 19:44:24 +0000 UTC
registry.redhat.io/rhceph/rhceph-7-rhel9@sha256:75bd8969ab3f86f2203a1ceb187876f44e54c9ee3b917518c4d696cf6cd88ce3
[ceph: root@storage /]#</pre>
</div>
</div>
<div class="listingblock">
<div class="title">Sample output</div>
<div class="content">
<pre>[ceph: root@storage /]# ceph -s
  cluster:
    id:     47cd0eae-5e5c-11ef-a284-5254000aa988
    health: HEALTH_OK

  services:
    mon: 1 daemons, quorum storage (age 18m)
    mgr: storage.wudgfp(active, since 16m)
    osd: 3 osds: 3 up (since 16m), 3 in (since 17m)
    rgw: 1 daemon active (1 hosts, 1 zones)

  data:
    pools:   5 pools, 129 pgs
    objects: 191 objects, 453 KiB
    usage:   148 MiB used, 5.9 TiB / 5.9 TiB avail
    pgs:     129 active+clean</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Wait until you see cluster health as "HEALTH_OK".
It may take 10 minutes to see the final status.
Message HEALTH_OK in the above output indicates good cluster state.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>You may also run ceph health command to verify cluster status.</p>
<div class="listingblock">
<div class="title">Sample output</div>
<div class="content">
<pre>[ceph: root@storage /]# ceph health
HEALTH_OK</pre>
</div>
</div>
</li>
<li>
<p>In case of failure, you can use following command to destroy the ceph storage cluster</p>
<div class="listingblock execute">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cephadm rm-cluster --force --zap-osds --fsid `ceph fsid`</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="section2.html">Initial Setup on Hypervisor (Bare Metal)</a></span>
  <span class="next"><a href="../chapter2/index.html">Hub Cluster Deployment</a></span>
</nav>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <img src="../../../_/img/rhl-logo-red.png" height="40px" alt="Red Hat"  href="https://redhat.com" >
</footer><script id="site-script" src="../../../_/js/site.js" data-ui-root-path="../../../_"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
